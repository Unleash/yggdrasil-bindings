name: Publish Java
on:
  workflow_dispatch:

jobs:

  publish_jars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v5
      - name: Read yggdrasilCoreVersion from gradle.properties
        id: read_ygg
        shell: bash
        working-directory: "./java-engine"
        run: |
          # Grab the last non-comment match in case the file has multiple entries
          line="$(grep -E '^[[:space:]]*yggdrasilCoreVersion[[:space:]]*=' gradle.properties | tail -n1 || true)"
          if [ -z "$line" ]; then
            echo "yggdrasilCoreVersion not found in gradle.properties" >&2
            exit 1
          fi

          # Extract the value (right side of =) and trim whitespace/CRLF
          value="${line#*=}"
          # trim leading/trailing spaces
          value="$(printf '%s' "$value" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
          # strip possible CR from Windows checkouts
          value="${value%$'\r'}"

          echo "ygg_version=$value" >> "$GITHUB_OUTPUT"
      - name: Read java library version from gradle.properties
        id: read_java_engine
        shell: bash
        working-directory: ./java-engine
        run: |
          # Grab the last non-comment match in case the file has multiple entries
          line="$(grep -E '^[[:space:]]*version[[:space:]]*=' gradle.properties | tail -n1 || true)"
          if [ -z "$line" ]; then
            echo "version not found in gradle.properties" >&2
            exit 1
          fi
          
          # Extract the value (right side of =) and trim whitespace/CRLF
          value="${line#*=}"
          # trim leading/trailing spaces
          value="$(printf '%s' "$value" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
          # strip possible CR from Windows checkouts
          value="${value%$'\r'}"
          
          echo "java_version=$value" >> "$GITHUB_OUTPUT"
      - name: Download binaries
        shell: bash
        working-directory: ./java-engine
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "yggdrasilffi-v${{ steps.read_ygg.outputs.ygg_version }}" --repo Unleash/yggdrasil-bindings -D binaries/
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: 21
          cache: 'gradle'
          distribution: 'temurin'
      - name: Publish to Maven Central Portal
        working-directory: ./java-engine
        env:
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingPassphrase: ${{ secrets.GPG_PASSPHRASE }}
          ORG_GRADLE_PROJECT_mavenCentralToken: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        run: |
          ./gradlew publishToMavenCentralPortal
      - name: Make a tag for the java release
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'refs/tags/java-engine-v${{ steps.read_java_engine.outputs.java_version }}',
            sha: context.sha
            })