name: Publish Java
on:
  workflow_dispatch:

jobs:

  publish_jars:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v5
      - name: Read yggdrasilCoreVersion from gradle.properties
        id: read_ygg
        shell: bash
        run: |
          # Grab the last non-comment match in case the file has multiple entries
          line="$(grep -E '^[[:space:]]*yggdrasilCoreVersion[[:space:]]*=' gradle.properties | tail -n1 || true)"
          if [ -z "$line" ]; then
            echo "yggdrasilCoreVersion not found in gradle.properties" >&2
            exit 1
          fi

          # Extract the value (right side of =) and trim whitespace/CRLF
          value="${line#*=}"
          # trim leading/trailing spaces
          value="$(printf '%s' "$value" | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
          # strip possible CR from Windows checkouts
          value="${value%$'\r'}"

          echo "ygg_version=$value" >> "$GITHUB_OUTPUT"

      - name: Download binaries
        shell: bash
        working-directory: ./java-engine
        run: |
          gh release download "yggdrasilffi-v${{ steps.read_ygg.outputs.ygg_version }}" --repo Unleash/yggdrasil-bindings -D binaries/
      - name: Publish to Maven Central Portal
        working-directory: ./java-engine
        env:
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingPassphrase: ${{ secrets.GPG_PASSPHRASE }}
          ORG_GRADLE_PROJECT_mavenCentralToken: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        run: |
          ./gradlew publishToMavenCentralPortal
